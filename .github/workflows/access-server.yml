name: Access server
on: push
jobs:
  access_server:
    name: Access server
    runs-on: ubuntu-latest
    steps:
      - name: Create a file
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          run: |
            sudo apt-get -y update
            cd django_project/django-deployment-guide
            git pull origin main

            # Add error handling for Git pull
            if [ $? -ne 0 ]; then
              echo "Error: Git pull failed."
              exit 1
            fi

            # Build and run Docker container only if Dockerfile has changed
            if [ "${{ steps.dockerfile_changed.outputs.changed }}" == 'true' ]; then
              docker build -t my-python-app:1.0 .
            fi
            docker run -p 8000:8000 my-python-app:1.0
